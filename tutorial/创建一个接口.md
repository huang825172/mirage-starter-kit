# 创建一个接口

跟随这篇指引，你将基于 `Mirage-Starter-Kit`  的服务端代码，一步步创建一个简单的时间接口。其中涉及到的内容包括 **控制器编写、路由设置、数据库读写等**。在指引的最后，你将能够通过接口获得时间数据，并在系统中留下访问记录。

## 基本概念

### ORM（Object Relational Mapping 对象关系映射）

此处的 ORM 一般指数据库操作中所使用的对象关系映射库。其功能一般体现为：将使用 `SQL` 语句对数据库进行的操作抽象为使用编程语言面向对象特性进行的对象操作。本框架使用了 `Sequelize` 作为 ORM 框架。

在 ORM 模式中，**Model** 是一个重要的概念。其一般指根据数据库存储结构构建的 **类对象**。在本框架中，`Model` 代码位于 `server/db/model.js` 中：

```javascript
// 引入 ORM 框架
const sequelize = require('./db')
// 引入定义 Model 所需模块
const { Model, DataTypes } = require('sequelize');

// 参考：https://sequelize.org/master/manual/model-basics.html

// 设计数据表
// 此处定义了一张名为 clicks 的数据表，将对应 Model 对象命名为 Click
// 首先需要新建一个继承于 Model 的类
class Click extends Model { }
// 调用 Model 对象的初始化方法，定义其数据域和其他属性
Click.init({
    // 定义了一个名为 id 的域，类型为整数，设为自增主键
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true }
}, {
    // 传入 ORM 框架实例并定义数据表名
    sequelize,
    tableName: 'clicks',
});
```

完成 model 的定义后，可以进行 `sync` 操作，将数据表结构同步到数据库，即创建数据表、插入默认数据等。

```javascript
// 在 app.js 中
// ...
// 引入并初始化数据库
const sequelize = require('./db/db')
require('./db/model');
sequelize.sync({ force: true });
// ...
```

对 model 的具体操作在下一个概念中会提及。

### 控制器（Controller）

控制器是后端逻辑的实现，是连接数据和视图的代码。在 `Mirage-Starter-Kit` 中，控制器代码位于 `server/controllers` 目录下。控制器代码是一个个响应请求的函数，具有访问数据库等后端资源的能力。以框架中的计数器控制器（`server/controllers/counter.js`）为例：

```javascript
// 引入数据库操作框架
const sequelize = require('../db/db');

// 参考：https://sequelize.org/master/manual/model-querying-basics.html

// 向数据库添加一次点击记录
async function addCounter(req, res) {
    try {
        // 验证数据库连接
        await sequelize.authenticate();
        // 调用 Model 对象的 create 方法，创建并保存一次新的点击记录
        await sequelize.models.Click.create();
        // 返回 JSON 格式数据
        res.send(JSON.stringify({
            status: 'OK'
        }));
    } catch (err) {
        // 如果响应流程出错
        console.log(err);
        res.send(JSON.stringify({
            status: 'FAIL',
            err: err
        }));
    }
}

// 统计数据库中的记录数量
async function getCounter(req, res) {
    try {
        // 验证数据库连接
        await sequelize.authenticate();
        // 调用 Model 对象的 findAll 方法，查询得到所有记录的数组
        const count = (await sequelize.models.Click.findAll()).length;
        // 返回 JSON 格式数据
        res.send(JSON.stringify({
            status: "OK",
            count: count
        }));
    } catch (err) {
        // 如果响应流程出错
        console.log(err);
        res.send(JSON.stringify({
            status: 'FAIL',
            err: err
        }));
    }
}

module.exports = { addCounter, getCounter };
```



